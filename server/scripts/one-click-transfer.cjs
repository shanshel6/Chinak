// ONE-CLICK DRAFT TRANSFER - Ultimate solution for browser localStorage transfer

const fs = require('fs');
const path = require('path');

console.log('ğŸš€ ONE-CLICK DRAFT TRANSFER SYSTEM');
console.log('===================================');

// Find all scraped JSON files
const jsonFiles = fs.readdirSync(__dirname)
  .filter(file => file.startsWith('1688-') && file.endsWith('.json'))
  .map(file => ({
    name: file,
    path: path.join(__dirname, file),
    time: fs.statSync(path.join(__dirname, file)).mtime.getTime()
  }))
  .sort((a, b) => b.time - a.time);

if (jsonFiles.length === 0) {
  console.log('âŒ No scraped JSON files found!');
  console.log('ğŸ’¡ Run the scraper first: node individual-product-scraper.cjs "URL")');
  process.exit(1);
}

console.log(`ğŸ“ Found ${jsonFiles.length} scraped file(s):`);
jsonFiles.forEach((file, index) => {
  console.log(`   ${index + 1}. ${file.name} (${new Date(file.time).toLocaleTimeString()})`);
});

// Process the latest file
const latestFile = jsonFiles[0];
console.log('\nğŸ¯ Processing latest file:', latestFile.name);

try {
  const scrapedData = JSON.parse(fs.readFileSync(latestFile.path, 'utf8'));
  
  // Extract products (handle both array and object formats)
  const products = scrapedData.products || 
                  (Array.isArray(scrapedData) ? scrapedData : [scrapedData]);
  
  console.log(`ğŸ“Š Found ${products.length} product(s) in the file`);
  
  // Convert to admin draft format
  const drafts = products.map((product, index) => ({
    name: product.product_name || product.title_en || `Product ${index + 1}`,
    chineseName: product.title_cn || '',
    description: product.description_ar || product.description || '',
    price: product.converted_price_iqd || 0,
    basePriceRMB: product.price_rmb || 0,
    image: product.main_image || (product.main_images && product.main_images[0]) || '',
    images: product.images || product.main_images || [],
    status: 'DRAFT',
    isActive: false,
    isFeatured: false,
    purchaseUrl: product.product_url || '',
    specs: {
      moq: product.moq || 1,
      company: product.company_name || '',
      location: product.company_location || '',
      weight_kg: product.weight_kg || 0.5,
      original_price_rmb: product.price_rmb || 0,
      converted_price_iqd: product.converted_price_iqd || 0
    },
    storeEvaluation: {
      responseRate: product.response_rate || '',
      transactionRate: product.transaction_rate || ''
    },
    weight: product.weight_kg || 0.5,
    length: 20,
    width: 15,
    height: 10,
    domesticShippingFee: 0,
    id: `local-${Date.now()}-${index}`,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    isLocal: true
  }));

  // Generate the transfer code
  const jsonString = JSON.stringify(drafts)
    .replace(/'/g, "\\'")
    .replace(/\n/g, ' ');

  const transferCode = `
// ğŸš€ AUTO-GENERATED BY ONE-CLICK TRANSFER
// ğŸ“… Generated: ${new Date().toLocaleString()}
// ğŸ“ Source: ${latestFile.name}
// ğŸ“Š Products: ${drafts.length}

localStorage.setItem('admin_local_drafts', '${jsonString}');
console.log('âœ… ${drafts.length} draft product(s) loaded into localStorage');
console.log('ğŸ”„ Refresh http://localhost:5173/admin/products to see drafts');

// ğŸ“‹ PRODUCTS TRANSFERRED:
${drafts.map((draft, index) => `// ${index + 1}. ${draft.name}${draft.price > 0 ? ` (${draft.price} IQD)` : ''}`).join('\n')}
`;

  // Save to file
  const transferFile = path.join(__dirname, 'LATEST-TRANSFER-CODE.js');
  fs.writeFileSync(transferFile, transferCode);
  
  console.log('\n' + '='.repeat(70));
  console.log(transferCode);
  console.log('='.repeat(70));
  
  console.log('ğŸ’¾ Transfer code saved to: LATEST-TRANSFER-CODE.js');
  console.log('\nğŸ“‹ QUICK INSTRUCTIONS:');
  console.log('1. Open: http://localhost:5173/admin/products');
  console.log('2. Press F12 â†’ Console tab');
  console.log('3. Paste the code above');
  console.log('4. Press Enter, then refresh the page!');
  console.log('\nğŸ‰ DONE! Your drafts are ready for the admin dashboard.');
  
} catch (error) {
  console.error('âŒ Error:', error.message);
  console.log('ğŸ’¡ Make sure the JSON file format is correct');
}